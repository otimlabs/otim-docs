name: Update Deployed Contract Addresses

on:
  repository_dispatch:
    types: [contract-addresses-updated]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  setup-prompt:
    runs-on: ubuntu-latest
    outputs:
      environment-data: ${{ steps.collect-env.outputs.data }}
      template: ${{ steps.setup-template.outputs.template }}
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v5
      
    - name: Checkout otim-protocol
      uses: actions/checkout@v5
      with:
        repository: otimlabs/otim-protocol
        path: otim-protocol
        
    - name: Collect protocol environment settings
      id: collect-env
      run: |
        # Collect all environment files for processing
        {
          for network in mainnet testnet; do
            for file in otim-protocol/.github/networks/$network/.env-*; do
              if [ -f "$file" ]; then
                echo "=== $network: $(basename $file) ==="
                cat "$file"
                echo ""
                echo ""
              fi
            done
          done
        } > /tmp/env_data.txt
        
        # Store as output
        echo "data<<EOF" >> $GITHUB_OUTPUT
        cat /tmp/env_data.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Setup contract address MDX template
      id: setup-template
      run: |
        # Read template file and store as output
        echo "template<<EOF" >> $GITHUB_OUTPUT
        cat .github/templates/deployed-addresses.mdx.tmpl >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

  submit-prompt:
    runs-on: ubuntu-latest
    needs: setup-prompt
    outputs:
      mdx-content: ${{ steps.submit-prompt.outputs.content }}
    
    steps:
    - name: Submit prompt to OpenAI
      id: submit-prompt
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        SYSTEM_PROMPT="Generate MDX content (without code block wrappers) for contract addresses from environment variables."
        
        # Create user prompt with proper escaping
        cat > /tmp/user_prompt.txt << 'USER_EOF'
        Generate MDX content following this template:

        ${{ needs.setup-prompt.outputs.template }}

        Extract EXPECTED_*_ADDRESS variables from these environment files:

        ${{ needs.setup-prompt.outputs.environment-data }}

        Requirements:
        - Extract ALL *_ADDRESS environment variables (no exclusions)
        - Convert envvar (CONTRACT_NAME_ADDRESS) to ContractName format
        - Group core contracts (Gateway, OtimDelegate, InstructionStorage, FeeTokenRegistry, Treasury, ActionManager) under Core Contracts
        - Group action contracts under Action Contracts with chain tabs (examples: DeactivateInstructionAction, SweepCCTPAction, TransferCCTPAction, SweepUniswapV3Action, UniswapV3ExactInputAction, RefuelAction, RefuelERC20Action, TransferAction, TransferERC20Action, SweepAction, SweepERC20Action)
        - Include common action contracts from .env-otim-* files in ALL chain tabs within each network (Mainnet/Testnet)
        - Create tabs for ALL chains including specific examples: Base, Arbitrum, Ethereum, Optimism, Base Sepolia, Arbitrum Sepolia, Ethereum Sepolia, Optimism Sepolia, Pecorino Host, Pecorino Signet
        - Do NOT create chain tabs for .env-otim-* files (they contain shared core contracts) - treat all other files as chains
        - Sort all contract names alphabetically within each table
        USER_EOF

        USER_PROMPT=$(cat /tmp/user_prompt.txt)

        # Create JSON payload using jq for proper escaping
        jq -n \
          --arg system "$SYSTEM_PROMPT" \
          --arg user "$USER_PROMPT" \
          '{
            "model": "gpt-4o",
            "messages": [
              {"role": "system", "content": $system},
              {"role": "user", "content": $user}
            ],
            "max_tokens": 8000,
            "temperature": 0
          }' > /tmp/openai_payload.json
        
        # Call API and extract content
        curl -s "https://api.openai.com/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -d @/tmp/openai_payload.json | \
        jq -r '.choices[0].message.content // empty' > /tmp/deployed-addresses.mdx
        
        # Check for errors and store output
        if [ ! -s /tmp/deployed-addresses.mdx ]; then
          echo "Error: OpenAI API failed"
          exit 1
        fi
        
        echo "content<<EOF" >> $GITHUB_OUTPUT
        cat /tmp/deployed-addresses.mdx >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Upload MDX artifact
      uses: actions/upload-artifact@v4
      with:
        name: mdx-content
        path: /tmp/deployed-addresses.mdx

  process-prompt-result:
    runs-on: ubuntu-latest
    needs: submit-prompt
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Download MDX artifact
      uses: actions/download-artifact@v5
      with:
        name: mdx-content
        path: docs/developers
        
    - name: Generate GitHub App Token
      id: bot_token
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
      with:
        app_id: ${{ secrets.GH_APP_ID }}
        private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        
    - name: Create PR for address updates
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ steps.bot_token.outputs.token }}
        commit-message: "Update deployed contract addresses (AI-generated)"
        title: "Sync: Deployed Contract Addresses"
        body: |
          Contract address extraction completed using AI.
          
          **Run**: [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        branch: update-deployed-addresses-ai
        base: main
        delete-branch: true
