name: Update Action Schemas from otim-offchain

on:
  workflow_dispatch:
    inputs:
      otim_offchain_ref:
        description: 'otim-offchain repository ref (branch/tag/commit)'
        required: true
        default: 'main'

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update-actions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v5
      
    - name: Checkout otim-offchain
      uses: actions/checkout@v5
      with:
        repository: otimlabs/otim-offchain
        ref: ${{ github.event.inputs.otim_offchain_ref || 'main' }}
        path: otim-offchain
        
    - name: Extract Rust ActionArguments and update OpenAPI
      id: update-openapi
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # Read the Rust ActionArguments enum
        RUST_CONTENT=$(cat otim-offchain/crates/core/src/lib.rs)
        
        # Read current OpenAPI spec
        OPENAPI_CONTENT=$(cat api-reference/openapi.yaml)
        
        # Create prompt for OpenAI
        cat > /tmp/prompt.txt << 'PROMPT_EOF'
        You are an expert at converting Rust enum definitions to OpenAPI schemas. 

        I have a Rust ActionArguments enum and need you to update the corresponding OpenAPI schema.

        RUST ActionArguments enum:
        ```rust
        $RUST_CONTENT
        ```

        CURRENT OpenAPI ActionArguments schema:
        ```yaml
        $OPENAPI_CONTENT
        ```

        Please:
        1. Parse the Rust ActionArguments enum and identify all action variants
        2. For each variant, extract the field names, types, and comments
        3. Update the OpenAPI ActionArguments oneOf array with proper schemas
        4. Map Rust types to appropriate OpenAPI types (Address -> string/address, U256 -> integer/uint256, etc.)
        5. Update the discriminator mapping
        6. Update the actionName enum in GetInstructionDetailsResponse
        7. Maintain the same YAML structure and formatting
        8. Return ONLY the complete updated OpenAPI YAML, no explanations

        Focus on:
        - Converting Rust field types to OpenAPI equivalents
        - Preserving field descriptions from Rust comments
        - Maintaining proper OpenAPI schema structure
        - Adding any missing action types
        PROMPT_EOF

        PROMPT=$(cat /tmp/prompt.txt)

        # Call OpenAI API
        RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"model\": \"gpt-4o\",
            \"messages\": [
              {\"role\": \"system\", \"content\": \"You are an expert at converting Rust code to OpenAPI schemas.\"},
              {\"role\": \"user\", \"content\": \"$PROMPT\"}
            ],
            \"temperature\": 0.1
          }")

        # Extract the updated OpenAPI content
        UPDATED_OPENAPI=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
        
        # Write the updated OpenAPI spec
        echo "$UPDATED_OPENAPI" > api-reference/openapi.yaml
        
        echo "OpenAPI spec updated successfully"
        
    - name: Generate GitHub App Token
      id: bot_token
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a
      with:
        app_id: ${{ secrets.GH_APP_ID }}
        private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        
    - name: Create PR for OpenAPI updates
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ steps.bot_token.outputs.token }}
        commit-message: "Update ActionArguments schema from otim-offchain"
        title: "Sync: Action Schemas from otim-offchain"
        body: |
          Action schema synchronization completed using OpenAI.
          
          **Source**: otim-offchain@${{ github.event.inputs.otim_offchain_ref || 'main' }}
          **Trigger**: Manual workflow dispatch
          **Run**: [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        branch: update-action-schemas-ai
        base: main
        delete-branch: true
